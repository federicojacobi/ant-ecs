(()=>{var p=class{constructor(){this.components=new Map}};var o=class{#s=[];#o=[];#r=[];#i=[];#e=new Map;#n=new Map;#t=new Map;#h=[];constructor(){}getNextEntity(){let t;return 0<this.#o.length?t=this.#o.pop():t=new p,this.#s.push(t),this.updateQueries(t),t}killEntity(t){this.#r.push(t)}registerComponent(t){this.#n.set(t.type,t)}getNextComponent(t){if(!this.#n.has(t))throw new Error(`${t} component is not registered`);if(this.#t.has(t)&&0<this.#t.get(t).length){let e=this.#n.get(t),s=this.#t.get(t).pop();return Object.assign(s,e),s}return{...this.#n.get(t)}}removeComponent(t,e=[]){return(Array.isArray(e)?e:[e]).forEach(i=>{if(t.components.has(i)){let n=t.components.get(i);this.#i.push(n),t.components.delete(i)}}),this.updateQueries(t),this}addComponent(t,e=[]){return Array.isArray(e)?e.forEach(s=>{t.components.set(s.type,s)}):t.components.set(e.type,e),this.updateQueries(t),this}updateQueries(t){for(let[e,s]of this.#e.entries()){let i=s.indexOf(t),n=e(t);n&&i===-1?s.push(t):!n&&-1<i&&s.splice(i,1)}}query(t){if(this.#e.has(t))return this.#e.get(t);let e=this.#s.filter(t);return this.#e.set(t,e),e}addSystem(t){if(!this.#h.includes(t))return this.#h.push(t),t.ecs=this,t.init(),t;throw new Error("This system already exists")}#p(){for(;0<this.#r.length;){let t=this.#r.pop(),e=this.#s.indexOf(t);if(e===-1)continue;let[s]=this.#s.splice(e,1);s.components.forEach(i=>{this.#i.push(i)}),s.components.clear(),this.#o.push(s);for(let i of this.#e.values()){let n=i.indexOf(t);-1<n&&i.splice(n,1)}}for(;0<this.#i.length;){let t=this.#i.pop();this.#t.has(t.type)||this.#t.set(t.type,[]),this.#t.get(t.type).push(t)}}update(t){this.#h.forEach(e=>e.update(t)),this.#p()}};var r=class{init(){}update(t){}destroy(){}};function c(h){let t=h,e=null;return{create(){return e=t.getNextEntity(),this},addComponent(s,i=null){if(!e)throw"Create an entity before adding a component.";let n=t.getNextComponent(s);return t.addComponent(e,n),i!==null&&Object.assign(n,i),this},setEntity(s){e=s},getEntity(){return e}}}window.ECS=o;window.System=r;window.Scaffold=c;})();

(()=>{var p=class{constructor(){this.components=new Map}};var o=class{constructor(){this.entities=[],this.entityPool=[],this.dirtyEntities=[],this.dirtyComponents=[],this.queries=new Map,this.blueprint=new Map,this.componentPool=new Map,this.systems=[]}getNextEntity(){let t;return 0<this.entityPool.length?t=this.entityPool.pop():t=new p,this.entities.push(t),this.updateQueries(t),t}killEntity(t){this.dirtyEntities.push(t)}registerComponent(t){this.blueprint.set(t.type,t)}getNextComponent(t){if(!this.blueprint.has(t))throw new Error(`${t} component is not registered`);if(this.componentPool.has(t)&&0<this.componentPool.get(t).length){let e=this.blueprint.get(t),s=this.componentPool.get(t).pop();return Object.assign(s,e),s}return{...this.blueprint.get(t)}}removeComponent(t,e=[]){return(Array.isArray(e)?e:[e]).forEach(i=>{if(t.components.has(i)){let n=t.components.get(i);this.dirtyComponents.push(n),t.components.delete(i)}}),this.updateQueries(t),this}addComponent(t,e=[]){return Array.isArray(e)?e.forEach(s=>{t.components.set(s.type,s)}):t.components.set(e.type,e),this.updateQueries(t),this}updateQueries(t){for(let[e,s]of this.queries.entries()){let i=s.indexOf(t),n=e(t);n&&i===-1?s.push(t):!n&&-1<i&&s.splice(i,1)}}query(t){if(this.queries.has(t))return this.queries.get(t);let e=this.entities.filter(t);return this.queries.set(t,e),e}addSystem(t){if(!this.systems.includes(t))return this.systems.push(t),t.ecs=this,t.init(),t;throw new Error("This system already exists")}#t(){for(;0<this.dirtyEntities.length;){let t=this.dirtyEntities.pop(),e=this.entities.indexOf(t);if(e===-1)continue;let[s]=this.entities.splice(e,1);s.components.forEach(i=>{this.dirtyComponents.push(i)}),s.components.clear(),this.entityPool.push(s);for(let i of this.queries.values()){let n=i.indexOf(t);-1<n&&i.splice(n,1)}}for(;0<this.dirtyComponents.length;){let t=this.dirtyComponents.pop();this.componentPool.has(t.type)||this.componentPool.set(t.type,[]),this.componentPool.get(t.type).push(t)}}update(t){this.systems.forEach(e=>e.update(t)),this.#t()}};var r=class{init(){}update(t){}destroy(){}};function u(h){let t=h,e=null;return{create(){return e=t.getNextEntity(),this},addComponent(s,i=null){if(!e)throw"Create an entity before adding a component.";let n=t.getNextComponent(s);return t.addComponent(e,n),i!==null&&Object.assign(n,i),this},setEntity(s){e=s},getEntity(){return e}}}window.ECS=o;window.System=r;window.Scaffold=u;})();
